---
layout: post
title: "안드로이드와 자동화 툴"
author: steve
categories: [android]
description: 토스랩 안드로이드 팀이 하는 자동화를 공유해드립니다.
tags: [android, automation, jenkins, resource]
fullview: true
---

# 안드로이드와 자동화 툴

모바일은 플랫폼의 생태계와 규모에 비해 개발자들이 처리해야 할 것이 매우 많습니다.

서버나 타 플랫폼들 또한 개발자들의 영역이 많지만 그 영역들이 세분화되고 전문화되어 가고 있습니다. 데이터베이스, 백엔드, 프론트웨어, 인프라, DevOps 와 같이 점점 분야별로 심화되고 독립성을 갖추어 가고 있습니다.

하지만 모바일은 각 플랫폼의 개발자들이 전체적인 아키텍쳐, 프론트, 내부용 데이터베이스, 리소스 관리, 배포 등이 해당 플랫폼의 소수의 개발자들에게 광범위하게 공존합니다. 다양한 분야가 전문화되기엔 변화가 잦고 규모가 점 형태로 구성이 된 경우가 많기 때문입니다.

그렇기 때문에 반복적이고 불필요하게 비용이 소모되는 작업일수록 자동화 해서 최대한 코드 작성 본연에 업무에 집중할 수 있도록 환경을 구성하는 것이 중요합니다.

토스랩 안드로이드 팀은 2015년 초부터 조금씩 자동화 환경을 구성하여 현재는 아래와 같습니다.

1. 다국어 문자 관리 자동화
2. 이미지 관리 자동화
3. CI

## 다국어 문자 리소스 자동화
![String-resource-diagram](/assets/media/post_images/string_resource_script_dialog.jpg)

### 1. 다국어 글로벌 담당자의 원본 문서
토스랩은 다국어 지원을 위해 글로벌 번역 문서를 관리하고 있습니다. 문서는 Google Drive 를 통해서 관리되고 있으며 기획/개발 파트에서 다국어 지원을 위한 리소스를 기입하면 각 언어의 담당자들이 해당 언어를 번역하고 있습니다.

구성은 아래와 같습니다

|A|B|C|D|E|F|G|H|
|----|----|----|----|----|----|----|----|
|영어|한국어|일본어|중국어-간체|중국어-번체|웹키|ios 키|안드로이드 키|


### 2. 기존 작업
기존에는 해당 언어의 번역 데이터를 추가하기 위해 개발 파트에서 **수동으로 각 언어의 리소스 파일에 추가하는 형태**로 진행하였습니다.

이러한 작업의 단점은 언어별 리소스 파일에 키-값 형태의 문자 리소스를 추가하는 작업을 반복적으로 해야 한다는 것입니다.
또한 반영이 된 후에 수정된 문자에 대해서 반영하기가 매우 어렵고 실수도 빈번하게 발생합니다.

이러한 가능성을 최소화 하기 위해 **자동으로 문자 리소스를 갱신하는 작업**을 진행하였습니다.

### 3. 안드로이드 파트를 위한 별도 필터 파일 추가
|A|B|C|D|E|F|
|----|----|----|----|----|----|
|영어|한국어|일본어|중국어-간체|중국어-번체|안드로이드 키|

가급적 원본 파일에 대한 조작을 피하기 위해 **안드로이드용으로 Read-Only SpreadSheet** 를 별도로 생성하였습니다.

해당 작업을 위해 Google SpreadSheet Script 를 사용하였습니다.

### 4. 자동화 툴 작업
자동화 툴의 역할은 크게 3가지였습니다.

1. 안드로이드용 필터 파일을 다운로드한다.
2. Spread-sheet를 분석해서 다국어용 자료구조로 변환한다.
3. 다국어용 자료구조를 XML 파일로 변경한다.

툴은 Python 스크립트로 작업하였습니다.

### 5. Gradle Task 로 추가

별도의 Python 파일을 실행해도 되지만 Gradle Task 로 추가하여 Android Studio 에서도 Task 를 실행할 수 있도록 하였습니다.

개발팀에서 안드로이드 키를 원본 문서에 추가한 후 Gradle Task 실행하면 바로 반영되도록 하였습니다. 기존의 방식과 가장 큰 차이점은 **Merge 시 충돌 이슈에 대해서 더이상 관여하지 않아도 된다**는 것입니다. 가장 최근 시점을 기준으로 자동화 Task 를 실행하면 모든 리소스가 최신화되기 때문에 충돌이 난다하더라도 무시하고 새로 Task 를 실행함으로써 **충돌에 의한 이슈를 완전히 배제하고 작업**할 수 있다는 장점이 생겼습니다.

더 나아가 현재는 Android 용 **리소스 Key를 기획 팀에서 기획시 적용**하도록 하기로 현재 논의되고 있습니다. 이러한 논의가 반영된다면 더이상 리소스 관리에 있어서 개발파트에서 관리 할 필요가 없어지므로 다국어 리소스에 반영해야할 리소스 또한 최소화 될 것이라 기대하고 있습니다.

## 이미지 리소스 자동화

![image-resource-script-dialog](/assets/media/post_images/image-resource-script-dialog.jpg)


### 1. 기존 작업
앱에 사용되는 디자인 리소스는 이슈 트래커와 JANDI 의 디자인 토픽을 통해서 전달 받아 작업을 하였습니다.

이런 작업 형태는 이미지 관리가 분산 될 뿐만 아니라 일관성 있는 전달 방식이 아니기 때문에 누락건이 언제든지 존재할 수 있습니다.

그래서 디자인 리소스에 대한 관리를 디자인 팀이 주도적으로 하며 개발팀에서는 빠르고 편하게 이미지를 전달 받을 수 있도록 하기 위해 자동화 툴을 만들었습니다.

### 2. 개선 작업

토스랩의 디자인 팀에서 사용하는 저장소는 권한에 따라 접근이 가능하도록 API 를 제공하고 있습니다. Read-Only 권한을 부여받은 후 API 를 통하여 이미지를 다운로드하도록 툴을 구성하였습니다.

툴은 Python 스크립트로 구성하였습니다.

### 3. Gradle Task 로 추가

문자 리소스와 마찬가지로 별도로 Gradle 로 툴을 이용할 수 있도록 하기 위해 별도의 Task 를 정의하여 사용하도록 하였습니다.


## 자동화된 리소스의 관리

문자와 이미지를 자동화로 관리한다 하더라도 개발자가 필요에 따라 임의로 추가/수정하는 리소스가 존재 할 수 있습니다.

이를테면 다운로드한 이미지 리소스를 활용한 Selector-Drawable 과 같은 것들입니다.

이에 따라 자동화 처리된 리소스들은 별도의 관리를 위해 추가적으로 ResourceSet 을 만들었습니다.

```groovy

android {
	// ...중략
	sourceSets {
		main.res.srcDirs += ${별도의_리소스_경로}
	}
}

```

이러한 방식을 통해서 **자동화된 리소스와 추가적한 리소스를 분리**하여 발생할 수 있는 문제를 최소화 하였습니다.

## 지속적 통합 (Continuous Integration, CI)

자동화와 관련되어서 결코 빠질 수 없는 내용입니다.
빌드, 테스트, 배포, 리포팅에 이르기까지 이 모든 과정에 있어서 자동화 되지 않았다면 상상하기 어려운 작업들입니다.

토스랩에서는 Jenkins 를 활용하여 빌드-테스트-리포팅을 하고 있습니다.

### 1. 빌드 대상
빌드의 의미는 최소한 컴파일 오류가 발생하지 않는 코드들이 최종 상태로 관리되고 있음을 의미합니다. 그러기 때문에 언제나 중앙 저장소에 반영되었거나 반영될 예정의 소스들은 항상 빌드 대상이라고 볼 수 있습니다.

안드로이드 팀은 내부적으로 빌드 대상이 되는 브랜치를 아래와 같이 정의하였습니다.

1. 개발된 이슈가 최종적으로 반영된 브랜치 (develop)
 - Github 에서 코드에 변경이 발생하면 이를 Jenkins 로 통보하여 해당 브랜치를 빌드합니다.

2. 개발 브랜치에 반영을 위해 코드리뷰 중인 브랜치 (features, fixes)
 - Github 에 새로운 Pull-Request 가 발생하면 Jenkins 로 통보하여 해당 브랜치를 빌드합니다.

테스트와 리포팅은 이 시점부터 발생한다고 볼 수 있습니다.

### 2. 빌드

빌드를 하는 과정에 **기본적인 정적 분석**을 사용하고 있습니다.
코드의 Convention 이나 복잡도 등을 측정하고 이를 분석하여 수정할 부분을 파악하기 위해서입니다.

### 3. 테스트

안드로이드팀은 작년 중순까지 Robolectric 이라는 Test Framework 을 사용하였으나 여러가지 이슈로 인하여 현재는 Android Test Support Library 를 사용하고 있습니다. ATSL 은 에뮬레이터를 필요로 하기 때문에 Jenkins 서버에 에뮬레이터를 구동하여 Test-Bed 를 구성하였습니다.

빌드 과정에서 정적 분석이 완료되면 테스트 코드를 동작 시킵니다.

테스트 된 결과는 JUnit Test Report 와 Jacoco Coverage Report 를 받고 있습니다.

### 4. 결과 리포트

![image-resource-script-dialog](/assets/media/post_images/jandi-webhook.jpg)

빌드, 테스트 결과는 Jenkins 에서 별도로 관리되고 있지만 모든 동작들은 자동화 되어 관리되기 때문에 별도의 장치가 없다면 알아채기 어렵습니다.

좀 더 빠른 피드백을 받기 위해 **JANDI-Webhook** 기능을 이용하여 결과 리포팅을 바로 받아 확인 할 수 있도록 하였습니다. 또한 **Github Pull-Request 화면에서 Build-Status 연동**하여 코드리뷰 하는 과정에서 잠재적 오류를 찾을 수 있도록 하였습니다.

※ 빌드된 결과물의 배포는 내부적인 정책으로 현재는 하지 않고 있습니다만, 현재 가용 가능한 리소스 안에서 해결 방안을 찾고 있습니다.

## 총평

자동화의 가장 큰 목적은 반복적이지만 시간을 소요하기엔 가치가 떨어지는 작업을 단순화 하기 위함이었습니다. 여기서 오는 가장 큰 의미는 관리에 소요되는 시간을 최소화함으로써 생산성을 향상 시켰다는 데에 있습니다.

특히 다국어 리소스와 이미지 리소스를 자동화 하기 위한 작업은 소요된 시간이 극히 미미하지만 그 효과는 매우 긍정적이라 할 수 있습니다.

CI 는 초기 설정뿐만 아니라 관리가 매우 어려운 작업입니다. 해당 시스템을 총체적으로 알고 있다는 가정에서 해야 하며 정책적으로 규정해야 하는 것들도 있습니다. 하지만 결과물 그 자체에 대한 관리를 위해서는 없어서는 안되는 도구이며 정적분석과 자동화 테스트 등 다양한 효과를 얻을 수 있기 때문에 많은 개발자들에게 권장하고 싶습니다.